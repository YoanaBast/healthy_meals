{% extends 'base.html' %}
{% load static %}

{% block title %}Generate Grocery List{% endblock %}

{% block content %}

<link rel="stylesheet" href="{% static 'css/planner_styles.css' %}">


<div class="container-home">
    <h2>Select Recipes</h2>
<p>Create your very own <a href="{% url 'user_grocery_list' %}">grocery list</a>.</p> <br>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <!-- Search & Filter -->
        <div style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center;">
            <input type="text" id="search-box" placeholder="Search by name..." oninput="filterRecipes()">
            <a href="?page=1{% if not show_favs %}&favs=1{% endif %}{% for r in selected_recipes %}&recipes={{ r }}{% endfor %}"
               class="btn btn-small">
                {% if show_favs %}Show All{% else %}Show Favourites Only{% endif %}
            </a>
        </div>

    <form method="POST" id="recipe-form">
        {% csrf_token %}

        {% for rec in page_obj %}
        <div class="recipe-line"
             data-fav="{{ rec.is_fav|yesno:'1,0' }}"
             data-name="{{ rec.name|lower }}">
            <label>
                <input type="checkbox"
                       class="recipe-checkbox"
                       name="recipes"
                       value="{{ rec.id }}"
                    {% if rec.id|stringformat:"s" in selected_recipes %}checked{% endif %}
                    onchange="updateSelection(this)">
                {{ rec.name }} {% if rec.is_fav %}<span class="fav-star">★</span>{% endif %}
            </label>
        </div>
        {% endfor %}

        <!--
            Hidden inputs carry selections from OTHER pages.
            On load, JS removes any hidden input whose ID matches a visible checkbox on
            this page (to avoid duplicates), then re-adds one for every pre-checked box.
        -->
        {% for r in selected_recipes %}
            <input type="hidden" class="hidden-selection" name="recipes" value="{{ r }}">
        {% endfor %}

<!--        <button type="submit" class="btn">Generate Grocery List</button>-->
    </form>

    {% if page_obj.has_other_pages %}
    <div class="pagination" style="text-align:center; margin-top:1rem;">
        {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}{% if show_favs %}&favs=1{% endif %}{% for r in selected_recipes %}&recipes={{ r }}{% endfor %}">« Prev</a>
        {% endif %}
        <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if show_favs %}&favs=1{% endif %}{% for r in selected_recipes %}&recipes={{ r }}{% endfor %}">Next »</a>
        {% endif %}
    </div>
    {% endif %}

    <button type="submit" form="recipe-form" class="btn" style="margin-top: 1rem;">Generate Grocery List</button>

</div>

<script src="{% static 'js/generate_grocery_item_handler.js' %}"></script>

{% endblock %}