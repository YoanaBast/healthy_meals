{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% load core_filters %}

{% block title %}Manage Fridge{% endblock %}

{% block content %}

<div class="container-home">

    <div id="manage-fridge" class="tab-content active">

        <!-- Title + Button Row -->
        <div class="section-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <div>
                <h2 class="section-title">Manage Your Fridge</h2>
                <p class="section-description">View and update the ingredients in your fridge here.</p>
            </div>
        <a href="#" id="openAddFridgeModal" class="btn">Add New Item</a>
        </div>

        <!-- ADD POPUP -->
        {% include 'planner/add_fridge_item_modal.html' %}

        <!-- DELETE POPUP -->
        {% include 'planner/delete_fridge_item_modal.html' %}

        <!-- Table with fridge items -->
        <table class="data-table">
            <thead>
                <tr>
                    <th>Ingredient</th>
                    <th>Quantity</th>
                    <th>Category</th>
                    <th>Dietary Tags</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for item in fridge %}
                <tr>


                    <td data-label="Ingredient">{{ item.ingredient.name|title_except  }}</td>

                    <td data-label="Quantity">
                        {% with item.ingredient.measurement_units|get_unit:item.unit as ing_unit %}
                            {{ item.quantity|smart_float }} {{ ing_unit|name_for_quantity:item.quantity|lower }}
                            {% with merge_explanations|get:item.ingredient.id as expl_list %}
                                {% if expl_list %}
                                    <span title="{% for expl in expl_list %}{{ expl }}{% if not forloop.last %}\n{% endif %}{% endfor %}">ðŸ›ˆ</span>
                                {% endif %}
                            {% endwith %}
                        {% endwith %}
                    </td>

                    <td data-label="Category">{{ item.ingredient.category|default:"-"  }}</td>

                    <td data-label="Dietary Tags">{{ item.ingredient.dietary_info }}</td>

                    <td data-label="Actions">
                        <div class="action-buttons">

                            <a href="{% url 'edit_fridge_item' item.id %}" class="btn btn-secondary btn-small">Edit</a>

                            <a href="{% url 'ingredient_detail' item.ingredient.id %}" class="btn btn-secondary btn-small">Details</a>
                            <button type="button"
                                    class="icon-delete-btn"
                                    onclick="openDeleteModal('fridge', {{ item.id }}, '{{ item.ingredient.name|escapejs }}')">

                                <img src="{% static 'images/delete-trash.svg' %}"
                                     alt="Delete">
                            </button>

                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" style="text-align: center; padding: 2rem;">
                        <h2 style="margin: 0;">No items in your fridge yet...</h2>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
<!-- END OF Table -->
{% if page_obj.has_other_pages %}
<div class="pagination" style="margin-top: 1rem; text-align: center;">
    {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}">Â« Prev</a>
    {% endif %}

    <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

    {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}">Next Â»</a>
    {% endif %}
</div>
{% endif %}
    </div>
</div>

<script src="{% static 'js/zero_inputt_handler.js' %}"></script>
<script src="{% static 'js/delete_popup.js' %}"></script>
<script src="{% static 'js/fridge_ingredient_loader.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('addFridgeItemModal');
    const openBtn = document.getElementById('openAddFridgeModal');
    const form = document.getElementById('addFridgeItemForm');

    // Open modal
    openBtn.addEventListener('click', function(e) {
        e.preventDefault(); // stop navigation
        modal.style.display = 'block';
    });

    // Close modal when clicking outside
    window.addEventListener('click', function(e) {
        if (e.target == modal) {
            modal.style.display = 'none';
        }
    });

    // Close modal on Cancel button
    const cancelBtn = modal.querySelector('button.btn-secondary');
    cancelBtn.addEventListener('click', function() {
        modal.style.display = 'none';
    });

    // Handle form submission without refreshing
    form.addEventListener('submit', function(e) {
        const qty = parseFloat(document.getElementById('quantityInput').value);
        const EPSILON = 0.001;

        console.log('Entered quantity:', qty);

        if (!qty || qty <= 0 || qty < EPSILON) {
            e.preventDefault(); // stop submission
            console.log('Quantity failed the check');
            alert('Quantity must be greater than 0.');
        } else {
            console.log('Quantity passed the check');
            // allow normal submit to Django
        }
    });
});
</script>

{% endblock %}
