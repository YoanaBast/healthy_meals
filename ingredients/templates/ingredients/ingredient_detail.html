{% extends 'base.html' %}
{% load static %}
{% load recipe_extras %}
{% load core_filters %}

{% block title %}
{{ ingredient.name }} Details
{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/ingredient_styles.css' %}">
<link rel="stylesheet" href="{% static 'css/ingredient_forms_styles.css' %}">

<div class="container-content">
    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
        <a href="javascript:history.back()" class="btn">Back</a>
        <a href="{% url 'edit_ingredient' ingredient.id %}" class="btn">Edit</a>
        <a href="{% url 'manage_ingredients' %}" class="btn">All Ingredients</a>
    </div>
    <button class="btn btn-danger" style="margin-left: auto;" onclick="openDeleteModal('ingredient', {{ ingredient.id }}, '{{ ingredient.name|escapejs }}')">Delete</button>
</div>


{% include 'ingredients/delete_ingredient_modal.html' %}


<div class="container-content">
    {% if messages %}
        {% for message in messages %}
            <div class="message {{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}


    <div class="grid-container">
        <div class="grid-item info">
            <h1 class="section-title">{{ ingredient.name|title_except }} </h1>

<!-- Details Table -->
                <table class="data-table">
                    <tbody>

                        <tr>
                            <th>Category</th>
                            <td>{{ ingredient.category|default:"-" }}</td>
                        </tr>

                        <tr>
                            <th>Base Quantity</th>
                            <td>{{ ingredient.base_quantity }}</td>
                        </tr>

                        <tr>
                            <th>Default Unit</th>
                            <td>{{ ingredient.default_unit|default:"-" }}</td>
                        </tr>

                        <tr>
                            <th>All Units</th>
                            <td>
                                {% for mu in ingredient.measurement_units.all %}
                                    {{ mu.unit.name_singular }} ({{ mu.unit.code }}) â€” {{ mu.conversion_to_base }} per base
                                    {% if not forloop.last %}<br>{% endif %}
                                {% empty %}
                                    -
                                {% endfor %}
                            </td>
                        </tr>

                        <tr>
                            <th>Dietary Information</th>
                            <td>{{ ingredient.dietary_info|default:"-" }}</td>
                        </tr>

                    </tbody>
                </table>
</div>

<!-- Unit Selection  -->
        <div class="grid-item info">
            <div class="nutrients-section" style="display: flex; flex-direction: column; gap: 1.5rem;">
                <form method="post" class="styled-form" novalidate>
                    {% csrf_token %}
                    <div class="form-group">

                        <p class="small-gray">This is the reference amount all nutrient values are calculated for. For example, if base quantity is 100g, all nutrients below represent what's in 100g of this ingredient.</p>
                        <br>
                        <label>Measurement unit:</label>

                        <select name="unit">
                            {% for mu in ingredient.measurement_units.all %}
                                <option value="{{ mu.id }}" {% if mu == selected_imu %}selected{% endif %}>
                                    {{ mu.unit.name_singular }} ({{ mu.unit.code }})
                                </option>
                            {% empty %}
                                <option disabled>No units defined</option>
                            {% endfor %}
                        </select>

                    </div>

                        <label>Quantity:</label>
                        <div class="form-group">
                            <input type="number" name="quantity" step="0.01" min="0.01" required placeholder="Quantity" value="{{ quantity }}">
                        </div>

                    <button type="submit" class="btn btn-secondary btn-small">Update</button>

                </form>
            </div>
        </div>

<!-- nutrients table -->
    <div class="nutrients-tables">
        <h2 style="font-size: 18px;">Nutrients for {{ quantity }} {{ unit_name }}:</h2>

            <table class="nutrients-table">
                <thead>
                    <tr><th>Nutrient</th><th>Amount</th></tr>
                </thead>
                <tbody>
                    {% for n, value in nutrients.items %}
                        <tr>
                            <td>{{ n|nice_name }}</td>
                            <td>{{ value }}</td>
                        </tr>
                    {% empty %}
                        <tr><td colspan="2">No nutrient info.</td></tr>
                    {% endfor %}
                </tbody>
            </table>

    </div>
    <br>

    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
        <a href="javascript:history.back()" class="btn">Back</a>
        <a href="{% url 'manage_ingredients' %}" class="btn">All Ingredients</a>
    </div>

<script src="{% static 'js/delete_popup.js' %}"></script>

{% endblock %}
