<div id="quick-add-modal" style="
    display:none; position:fixed; inset:0; z-index:1000;
    background:rgba(0,0,0,0.55); align-items:center; justify-content:center;">
    <div style="
        background:#1e1e2e; border:1px solid #444; border-radius:8px;
        padding:2rem; min-width:320px; max-width:420px; width:90%;">
        <h3 id="modal-title" style="margin-top:0;">Add New</h3>
        <input id="modal-input" type="text" placeholder="Enter name..."
               style="width:100%; box-sizing:border-box; margin-bottom:1rem;">
        <div id="modal-error" style="color:#ff6b6b; margin-bottom:0.75rem; display:none;"></div>
        <div style="display:flex; gap:0.5rem; justify-content:flex-end;">
            <button class="btn btn-danger" onclick="closeQuickModal()">Cancel</button>
            <button class="btn" onclick="submitQuickModal()">Save</button>
        </div>
    </div>
</div>

<script>
let _modalUrl = '';
let _targetSelect = null;

function getCookie(name) {
    const match = document.cookie.match(new RegExp('(^|;\\s*)' + name + '=([^;]*)'));
    return match ? decodeURIComponent(match[2]) : '';
}

function openQuickModal(title, url, selectId) {
    _modalUrl = url;
    _targetSelect = document.getElementById(selectId);
    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-input').value = '';
    document.getElementById('modal-error').style.display = 'none';
    document.getElementById('quick-add-modal').style.display = 'flex';
    setTimeout(() => document.getElementById('modal-input').focus(), 50);
}

function closeQuickModal() {
    document.getElementById('quick-add-modal').style.display = 'none';
}

async function submitQuickModal() {
    const name = document.getElementById('modal-input').value.trim();
    const errorEl = document.getElementById('modal-error');
    if (!name) {
        errorEl.textContent = 'Name cannot be empty.';
        errorEl.style.display = 'block';
        return;
    }

    const res = await fetch(_modalUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ name })
    });

    const data = await res.json();

    if (!res.ok) {
        errorEl.textContent = data.error || JSON.stringify(data);
        errorEl.style.display = 'block';
        return;
    }

    if (_targetSelect.tagName === 'SELECT') {
        const opt = new Option(data.name, data.id, true, true);
        _targetSelect.add(opt);
        opt.selected = true;
    } else {
        const index = _targetSelect.querySelectorAll('li').length; // next index
        const li = document.createElement('li');
        li.innerHTML = `<label for="id_dietary_tag_${index}">
            <input type="checkbox"
                   name="dietary_tag"
                   value="${data.id}"
                   id="id_dietary_tag_${index}"
                   checked>
            ${data.name}
        </label>`;
        _targetSelect.appendChild(li);
    }

    closeQuickModal();
}

document.getElementById('quick-add-modal').addEventListener('click', function(e) {
    if (e.target === this) closeQuickModal();
});

document.getElementById('modal-input').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') submitQuickModal();
});
</script>