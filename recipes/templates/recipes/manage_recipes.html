{% extends 'base.html' %}
{% load static %}
{% load form_extras %}

{% block title %}Manage Recipes{% endblock %}

{% block content %}

<div class="container-home">
<!-- Tabs -->
{% include 'tab_nav.html' with active_tab='manage-ingredients' %}

    <div id="manage-ingredients" class="tab-content active">


        <!-- Title + Button Row -->
        <div class="section-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <div>
                <h2 class="section-title">Manage Recipes</h2>
                <p class="section-description">Introduce the Foodganizer to new tasty recipes!</p>
            </div>

                <a href="{% url 'add_recipe' %}" class="btn">Add New Recipe</a>

        </div>


        <!-- DELETE POPUP -->
        {% include 'recipes/delete_recipe_modal.html' %}


        <!-- Table with all ingredients -->
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Recipe Name</th>
                            <th>Category</th>
                            <th>Dietary Information</th>
                            <th>Cooking Duration</th>
                            <th>Kcal per Serving</th>
                            <th>Servings</th>
                            <th>Actions</th>
                        </tr>

                    </thead>
                        <tbody>
                            {% for rec in recipes %}
                            <tr>
                                <td data-label="Ingredient Name">{{ rec.name }}</td>
                                <td data-label="Category">{{ rec.category|default:"-" }}</td>
                                <td data-label="Dietary Information"> {{ rec.dietary_info|default:"-" }}</td>
                                <td data-label="Cooking Duration">{{ rec.cooking_duration|default:"-"  }}</td>
                                <td data-label="Kcal per Serving">{{ rec.kcal_per_serving|default:"-"  }}</td>
                                <td data-label="Servings">{{ rec.servings|default:"-"  }}</td>

<!-- Actions -->
                                <td data-label="Actions">
                                    <div class="action-buttons">

                                    <!-- Favourite -->
                                        <button class="btn-heart" onclick="toggleFav({{ rec.id }}, this)">
                                            {% if rec.is_fav %}
                                                <img src="{% static 'images/full_heart.svg' %}" alt="fav" />
                                            {% else %}
                                                <img src="{% static 'images/empty_heart.svg' %}" alt="fav" />
                                            {% endif %}
                                        </button>

                                    <!-- Details -->
                                        <a href="{% url 'recipe_detail' rec.id %}" class="btn btn-secondary btn-small">Details</a>

                                    <!-- Edit -->
                                        <a href="{% url 'edit_recipe' rec.id %}" class="btn btn-secondary btn-small">Edit</a>

                                    <!-- Delete -->
                                        <button class="btn btn-danger btn-small"
                                                onclick="openDeleteModal('recipe', {{ rec.id }}, '{{ rec.name|escapejs }}')">
                                            Delete
                                        </button>

                                    </div>
                                </td>

 <!-- empty -->
                            {% empty %}
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 2rem;">
                                    <h2 style="margin: 0;">No recipes yet...</h2>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                </table>

    </div>
</div>

<!-- Script for quick save on popup -->

<script src="{% static 'js/zero_inputt_handler.js' %}"></script>
<script src="{% static 'js/delete_popup.js' %}"></script>
<script>
function toggleFav(recipeId, btn) {
    fetch(`/recipes/${recipeId}/toggle_fav/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(res => res.json())
    .then(data => {
        btn.innerHTML = data.favourited
            ? '<img src="{% static "images/full_heart.svg" %}" alt="fav" class="heart-icon" />'
            : '<img src="{% static "images/empty_heart.svg" %}" alt="fav" class="heart-icon" />';
    });
    }

// helper to get csrf token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
