{% extends 'base.html' %}
{% load static %}
{% block title %}Edit Recipe{% endblock %}

{% block content %}

<div id="recipe-meta"
     data-mode="edit"
     data-recipe-id="{{ recipe.pk }}"
     data-add-ingredient-url="{% url 'add_ingredient' recipe.pk %}"
     style="display:none;">
</div>

<div class="container-home">


    <div style="max-width: 800px; margin: 2rem auto;">
        <a href="javascript:history.back()" class="btn">← Back</a>
        <a href="{% url 'recipe_detail' recipe.pk %}" class="btn">Details</a>
        <a href="{% url 'manage_recipes' %}" class="btn">All Recipes</a>
    </div>

    <form method="post" action="{% url 'edit_recipe' recipe.pk %}" novalidate>
        {% csrf_token %}

        <!-- Recipe fields -->
        <div style="max-width: 800px; margin: 2rem auto;">
            <h2>Edit Recipe</h2>
        {% include "core/errors_label.html" with form=recipe_form %}

            <div class="grid-container">

                <div class="grid-item info">
                    <p>{{ recipe_form.name.label_tag }} {{ recipe_form.name }}</p>

                        <p>
                            {{ recipe_form.category.label_tag }}
                            <div style="display:flex; align-items:center; gap:0.4rem;">
                                {{ recipe_form.category }}
                                <button type="button" class="btn btn-small" title="Add new category"
                                    onclick="openQuickModal('Add Recipe Category', '{% url "add_recipe_category_ajax" %}', 'id_category')">+</button>
                                <button type="button" class="btn btn-small" title="Manage categories"
                                    onclick="fetchAndManage('{% url "list_recipe_categories_ajax" %}', 'Manage Categories')">⋯</button>
                            </div>
                        </p>

                    <p>
                        <label>Cooking Time:</label>
                        <span class="time-inputs">
                            {{ recipe_form.hours }} h
                            {{ recipe_form.minutes }} m
                        </span>
                    </p>
                </div>

                <div class="grid-item info">
                    <p>{{ recipe_form.servings.label_tag }} {{ recipe_form.servings }}</p>
                    <p>{{ recipe_form.instructions.label_tag }} {{ recipe_form.instructions }}</p>
                </div>

            </div>
        </div>

        <!-- Ingredients -->
        <div style="max-width: 800px; margin: 2rem auto;">
            {{ ingredient_formset.management_form }}

            <h3>Ingredients</h3>
            <div id="ingredientsContainer">
                {% if ingredient_formset.forms %}
                    {% for form in ingredient_formset.forms %}
                        <div class="ingredient-line">
                            {{ form.id }}
                            {{ form.ingredient.label_tag }} {{ form.ingredient }}
                            {{ form.quantity.label_tag }} {{ form.quantity }}
                            {{ form.unit.label_tag }} {{ form.unit }}
                    {% if form.instance.pk %}
                        <input type="checkbox" name="{{ form.DELETE.html_name }}"
                               id="{{ form.DELETE.id_for_label }}"
                               onchange="this.closest('.ingredient-line').style.opacity = this.checked ? '0.3' : '1'">
                        <label for="{{ form.DELETE.id_for_label }}">Delete</label>
                    {% endif %}


                        </div>
                    {% endfor %}
                {% else %}
                    <p style="color: var(--text-secondary); font-style: italic;">No ingredients yet.</p>
                {% endif %}

                {% include 'core/add_button.html' %}
            </div>
        </div>

        <!-- Save / Cancel -->
        <div style="max-width: 800px; margin: 2rem auto;">
            <button type="submit" class="btn btn-success">Save Recipe</button>
            <a href="{{ request.META.HTTP_REFERER|default:default_url }}" class="btn btn-secondary">Cancel</a>
        </div>

    </form>

{% include 'recipes/add_ingredients_to_recipe_modal.html' %}
{% include 'core/_quick_add_modal.html' %}
{% include 'core/_manage_list_modal.html' %}

</div>


<script src="{% static 'js/add_recipe_handler.js' %}"></script>
<script src="{% static 'js/zero_inputt_handler.js' %}"></script>
<script src="{% static 'js/fetch_and_manage.js' %}"></script>


{% endblock %}